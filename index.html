<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>$WALRUS Presale</title>

  <style>
    :root{
      --bg:#05070d;
      --card:#0c111b;
      --card2:#0a0f18;
      --text:#e9eefc;
      --muted:#b7c1dd;
      --teal:#00ffd0;
      --teal2:#00c7a4;
      --line:rgba(255,255,255,.08);
      --pill:rgba(0,255,208,.10);
      --shadow:0 18px 70px rgba(0,0,0,.55);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, rgba(0,255,208,.18), transparent 55%),
                  radial-gradient(900px 600px at 10% 20%, rgba(0,199,164,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      text-align:center;
    }

    .wrap{
      width:min(920px, 92vw);
      margin:0 auto;
      padding:22px 0 70px;
    }

    .hero{
      padding:10px 10px 0;
    }

    .banner{
      width:min(860px, 92vw);
      margin:0 auto 14px;
      border-radius:26px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.08);
    }

    .banner img{
      width:100%;
      display:block;
      height:auto;
    }

    h1{
      margin:12px 0 6px;
      font-size:54px;
      letter-spacing:2px;
      font-weight:900;
    }

    .sub{
      color:var(--muted);
      font-size:18px;
      margin-bottom:16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:22px;
      margin:16px auto;
      width:min(760px, 92vw);
      text-align:left;
    }

    .stageTitle{
      text-align:center;
      font-size:40px;
      font-weight:900;
      color:var(--teal);
      margin:6px 0 16px;
    }

    .row{
      display:flex;
      gap:14px;
      justify-content:center;
      flex-wrap:wrap;
      margin:8px 0 14px;
    }

    .pill{
      background: rgba(0,255,208,.10);
      border:1px solid rgba(0,255,208,.28);
      padding:12px 16px;
      border-radius:999px;
      font-weight:800;
      color:#dffef8;
      min-width: 240px;
      text-align:center;
    }

    .bigBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:min(440px, 92%);
      padding:18px 20px;
      border-radius:18px;
      margin:14px auto 12px;
      background: linear-gradient(180deg, var(--teal), #00f0c2);
      color:#00110c;
      font-weight:1000;
      font-size:28px;
      text-decoration:none;
      box-shadow: 0 16px 50px rgba(0,255,208,.18);
      border:0;
      cursor:pointer;
    }

    .small{
      font-size:13px;
      color:rgba(233,238,252,.75);
      margin-top:6px;
      text-align:center;
    }

    .label{
      color:rgba(233,238,252,.75);
      font-size:16px;
      margin:14px 0 10px;
      font-weight:800;
    }

    .walletBox{
      background: rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:14px;
      word-break:break-all;
      font-weight:800;
      letter-spacing:.2px;
      font-size:18px;
      text-align:left;
    }

    .copyBtn{
      margin-top:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 16px;
      border-radius:16px;
      border:1px solid rgba(0,255,208,.25);
      background: rgba(0,255,208,.10);
      color:#dffef8;
      font-weight:900;
      cursor:pointer;
    }

    .howto p{
      margin:8px 0;
      color:rgba(233,238,252,.92);
      font-weight:700;
      font-size:16px;
    }

    .tip{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.10);
      color:rgba(233,238,252,.78);
      font-size:14px;
      font-weight:700;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:720px){
      .twoCol{ grid-template-columns: 1fr; }
      h1{ font-size:46px; }
      .stageTitle{ font-size:34px; }
    }

    .input{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--text);
      font-weight:800;
      outline:none;
      font-size:15px;
    }

    .actionBtn{
      width:100%;
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,255,208,.25);
      background: rgba(0,255,208,.10);
      color:#dffef8;
      font-weight:900;
      cursor:pointer;
    }

    .result{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:rgba(233,238,252,.92);
      font-weight:800;
      font-size:14px;
      line-height:1.35;
      min-height:54px;
    }

    footer{
      margin-top:18px;
      opacity:.65;
      font-size:12px;
      padding:18px 10px 26px;
    }
    a.link{
      color:var(--teal);
      font-weight:900;
      text-decoration:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <!-- Optional banner image (uses your existing IMG_6472.jpeg) -->
      <div class="banner">
        <img src="IMG_6472.jpeg" alt="$WALRUS banner" />
      </div>

      <h1>$WALRUS</h1>
      <div class="sub">Presale â€¢ Built on Solana</div>
    </div>

    <div class="card">
      <div id="stageTitle" class="stageTitle">Stage 1 Presale</div>

      <div class="row">
        <div id="stagePricePill" class="pill">Stage 1 Price: $0.0000001</div>
        <div id="raisedPill" class="pill">Raised: 0.00 SOL</div>
      </div>

      <div class="row">
        <div id="nextStagePill" class="pill">Next Stage at: 100 SOL</div>
      </div>

      <!-- BUY button -->
      <a id="buyBtn" class="bigBtn" href="#" rel="noopener">BUY WITH SOL</a>
      <div class="small">Tip: This opens Phantom/Solflare with the presale wallet prefilled.</div>

      <div class="label">Presale Wallet</div>
      <div id="walletBox" class="walletBox">9RHnZobeZBKSLDaTVEiKk5FewZapSTJfyHnR396d7QEi</div>

      <button id="copyWalletBtn" class="copyBtn" type="button">ðŸ“‹ Copy Wallet</button>

      <div class="card howto" style="margin-top:16px;">
        <h2 style="margin:4px 0 10px; text-align:center;">How to Buy</h2>
        <p>1) Tap <b>BUY WITH SOL</b> (opens Phantom/Solflare)</p>
        <p>2) Send SOL to the presale wallet above</p>
        <p>3) Save your Solscan TX link (proof of payment)</p>
        <p>4) Tokens are distributed after launch (see official announcements)</p>
        <div class="tip">Tip: Donâ€™t send from an exchange. Send from Phantom/Solflare.</div>
      </div>

      <div class="twoCol">
        <div class="card" style="margin:0;">
          <h3 style="margin:4px 0 10px; text-align:center;">Check Your Contribution</h3>
          <input id="buyerWalletInput" class="input" placeholder="Paste your Solana wallet address (your sending wallet)" />
          <button id="checkBtn" class="actionBtn" type="button">Check</button>
          <div id="checkResult" class="result">
            Paste your wallet, then tap Check. Weâ€™ll total SOL sent to the presale wallet (on-chain).
          </div>
        </div>

        <div class="card" style="margin:0;">
          <h3 style="margin:4px 0 10px; text-align:center;">Official Links</h3>
          <div style="font-weight:900; margin-top:6px;">
            Website: <span style="opacity:.85;">walrusmemecoin.com</span>
          </div>
          <div style="margin-top:10px; font-weight:900;">
            X: <a class="link" href="https://x.com/walrusmemecoin" target="_blank" rel="noopener">@walrusmemecoin</a>
          </div>
          <div style="margin-top:10px; font-weight:900;">
            Solscan Wallet:
            <a id="solscanLink" class="link" href="#" target="_blank" rel="noopener">View</a>
          </div>
          <div style="margin-top:10px; font-size:13px; opacity:.8; font-weight:800;">
            Always verify links from official accounts.
          </div>
        </div>
      </div>
    </div>

    <footer>
      This page displays on-chain info (Raised SOL) from the presale wallet. Always verify addresses and transactions.
    </footer>
  </div>

  <script>
    /***********************
     * SETTINGS YOU CAN EDIT
     ***********************/
    const PRESALE_WALLET = "9RHnZobeZBKSLDaTVEiKk5FewZapSTJfyHnR396d7QEi";

    // Stage rules
    const STAGES_TOTAL = 20;
    const SOL_PER_STAGE = 100; // Stage 1 = 0-99.999..., Stage 2 = 100-199.999..., etc

    // Price display (USD) â€“ starts at $0.0000001 and increases each stage by a multiplier
    const STAGE1_PRICE_USD = 0.0000001;
    const PRICE_MULTIPLIER = 1.20; // 20% increase each stage (change if you want)

    // Public Solana RPC (fine for light use)
    const RPC_URL = "https://api.mainnet-beta.solana.com";

    /***********************
     * HELPERS
     ***********************/
    function formatSOL(x){
      return (Math.round(x * 100) / 100).toFixed(2);
    }

    function stageFromRaisedSOL(raised){
      const s = Math.floor(raised / SOL_PER_STAGE) + 1;
      return Math.min(Math.max(s, 1), STAGES_TOTAL);
    }

    function stagePriceUSD(stage){
      // stage 1 = base, stage 2 = base * mult, etc
      return STAGE1_PRICE_USD * Math.pow(PRICE_MULTIPLIER, (stage - 1));
    }

    function formatUSDPrice(x){
      // Show small values nicely (no scientific notation)
      // For your starting price, 7 decimals after leading zeros is good.
      if (x < 0.0001) return x.toFixed(7);       // 0.0000001 -> "0.0000001"
      if (x < 0.01)   return x.toFixed(6);
      if (x < 1)      return x.toFixed(4);
      return x.toFixed(2);
    }

    async function rpc(method, params){
      const res = await fetch(RPC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ jsonrpc:"2.0", id:1, method, params })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message || "RPC error");
      return data.result;
    }

    async function getWalletBalanceSOL(address){
      const result = await rpc("getBalance", [address]);
      const lamports = result.value || 0;
      return lamports / 1e9;
    }

    // Sum SOL transfers from a buyer wallet to PRESALE_WALLET by scanning buyer signatures
    // NOTE: This can be slow if they have tons of history. We limit to recent N.
    async function getBuyerSentSOLToPresale(buyerAddress, limit=40){
      const sigs = await rpc("getSignaturesForAddress", [buyerAddress, { limit }]);
      let total = 0;

      for (const s of sigs){
        const tx = await rpc("getTransaction", [s.signature, { maxSupportedTransactionVersion: 0 }]);
        if (!tx || !tx.transaction) continue;

        const message = tx.transaction.message;
        const accountKeys = message.accountKeys || [];
        const meta = tx.meta;

        // We need pre/post balances and find transfers where PRESALE_WALLET balance increases
        // Simplest heuristic:
        // If PRESALE_WALLET is in accountKeys, compute delta in lamports for that key
        const idx = accountKeys.findIndex(k => (typeof k === "string" ? k : k.pubkey) === PRESALE_WALLET);
        if (idx === -1) continue;

        const pre = (meta.preBalances && meta.preBalances[idx]) ? meta.preBalances[idx] : 0;
        const post = (meta.postBalances && meta.postBalances[idx]) ? meta.postBalances[idx] : 0;

        const delta = post - pre; // lamports gained by presale wallet
        if (delta > 0){
          // confirm buyerAddress is also involved (it is, because we searched buyerAddress signatures),
          // so count it
          total += delta / 1e9;
        }
      }
      return total;
    }

    /***********************
     * INIT UI
     ***********************/
    const walletBox = document.getElementById("walletBox");
    const buyBtn = document.getElementById("buyBtn");
    const solscanLink = document.getElementById("solscanLink");

    walletBox.textContent = PRESALE_WALLET;
    buyBtn.href = `solana:${PRESALE_WALLET}`; // opens wallet with address prefilled
    solscanLink.href = `https://solscan.io/account/${PRESALE_WALLET}`;

    // Copy wallet
    document.getElementById("copyWalletBtn").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(PRESALE_WALLET);
        alert("Wallet copied!");
      }catch(e){
        alert("Couldnâ€™t copy automatically. Tap and hold the wallet address to copy.");
      }
    });

    // Live raised + stage auto-update
    async function refreshRaisedAndStage(){
      try{
        const raised = await getWalletBalanceSOL(PRESALE_WALLET);
        const stage = stageFromRaisedSOL(raised);

        const nextThreshold = stage * SOL_PER_STAGE;
        const price = stagePriceUSD(stage);

        document.getElementById("stageTitle").textContent = `Stage ${stage} Presale`;
        document.getElementById("raisedPill").textContent = `Raised: ${formatSOL(raised)} SOL`;
        document.getElementById("nextStagePill").textContent =
          stage >= STAGES_TOTAL ? `Final Stage Reached` : `Next Stage at: ${nextThreshold} SOL`;

        document.getElementById("stagePricePill").textContent =
          `Stage ${stage} Price: $${formatUSDPrice(price)}`;

      }catch(err){
        console.log(err);
        document.getElementById("raisedPill").textContent = `Raised: (loading...)`;
      }
    }

    refreshRaisedAndStage();
    setInterval(refreshRaisedAndStage, 20000); // update every 20s

    // Buyer contribution checker
    document.getElementById("checkBtn").addEventListener("click", async () => {
      const input = document.getElementById("buyerWalletInput").value.trim();
      const out = document.getElementById("checkResult");

      if (!input || input.length < 32){
        out.textContent = "Paste a valid Solana wallet address first.";
        return;
      }

      out.textContent = "Checking recent transactionsâ€¦ (this may take 10â€“30s)";
      try{
        const sent = await getBuyerSentSOLToPresale(input, 40);

        // Estimate tokens at CURRENT stage price (this is only an estimate)
        const raised = await getWalletBalanceSOL(PRESALE_WALLET);
        const stage = stageFromRaisedSOL(raised);
        const price = stagePriceUSD(stage);

        // If your token is "USD priced", this is a placeholder estimate.
        // Replace with your real tokenomics when ready.
        const estTokens = price > 0 ? (sent / price) : 0;

        out.innerHTML = `
          <div><b>SOL sent to presale wallet (recent scan):</b> ${sent.toFixed(4)} SOL</div>
          <div style="margin-top:6px; opacity:.85;">
            <b>Estimated tokens</b> (using current Stage ${stage} price $${formatUSDPrice(price)}): ${Math.floor(estTokens).toLocaleString()}
          </div>
          <div style="margin-top:8px; font-size:12px; opacity:.75;">
            Note: This is an estimate and depends on your actual distribution rules.
          </div>
        `;
      }catch(err){
        console.log(err);
        out.textContent = "Couldnâ€™t load transaction data right now. Try again in a moment.";
      }
    });
  </script>
</body>
</html>
