<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>$WALRUS Presale</title>

  <style>
    :root{
      --bg:#05070d;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --aqua:#1ef7d9;
      --ring: rgba(30,247,217,.35);
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, rgba(0,255,208,.14), transparent 55%), var(--bg);
      color: var(--text);
      text-align:center;
    }
    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 26px 16px 36px;
    }
    .hero{ padding: 18px 10px 10px; }
    .logo{
      width: 260px;
      max-width: 90vw;
      border-radius: var(--radius);
      box-shadow: 0 0 36px var(--ring);
      display:block;
      margin: 0 auto 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    h1{ margin: 10px 0 6px; font-size: 54px; letter-spacing: 1px; }
    .sub{ opacity:.85; font-size: 18px; margin-bottom: 14px; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 22px 18px;
      margin: 18px auto;
      max-width: 740px;
      text-align:left;
    }

    .stageTitle{
      text-align:center;
      font-size: 44px;
      font-weight: 900;
      color: var(--aqua);
      margin: 6px 0 14px;
      text-shadow: 0 0 18px rgba(30,247,217,.25);
    }

    .row{
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap:wrap;
      margin: 6px 0 10px;
    }
    .pill{
      background: rgba(30,247,217,.10);
      border: 1px solid rgba(30,247,217,.30);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      min-width: 220px;
      text-align:center;
    }
    .pill b{color:#fff}
    .pill span{color: var(--muted)}

    .next{
      margin: 10px auto 2px;
      padding: 10px 14px;
      border-radius: 999px;
      display:inline-block;
      background: rgba(30,247,217,.08);
      border: 1px solid rgba(30,247,217,.22);
      color: var(--muted);
      font-weight: 800;
    }

    .btn{
      display:block;
      margin: 16px auto 10px;
      width:min(520px, 95%);
      padding: 18px 26px;
      border-radius: 18px;
      background: linear-gradient(180deg, var(--aqua), #71ffe9);
      color: #041012;
      font-weight: 1000;
      font-size: 26px;
      text-decoration:none;
      box-shadow: 0 14px 34px rgba(30,247,217,.25);
      text-align:center;
    }
    .smallMuted{color: var(--muted2); font-size: 13px; margin-top: 6px; text-align:center;}

    .sectionTitle{
      text-align:left;
      font-size: 16px;
      letter-spacing:.4px;
      color: var(--muted);
      margin: 18px 0 8px;
      font-weight: 900;
    }

    .walletBox{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 14px;
      text-align:left;
      overflow-wrap:anywhere;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 14px;
      color: #eafdf9;
    }

    .copyBtn{
      margin-top: 10px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(30,247,217,.12);
      border: 1px solid rgba(30,247,217,.25);
      color: #dffef8;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }

    .howto{
      text-align:left;
      color: var(--muted);
      line-height: 1.55;
      font-size: 15px;
      margin-top: 8px;
      font-weight: 700;
    }
    .howto b{color:#fff}
    .tip{ margin-top: 10px; font-size: 13px; color: var(--muted2); }

    .statusLine{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted2);
      text-align:center;
      min-height: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media(max-width:760px){
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size: 46px; }
      .stageTitle{ font-size: 36px; }
    }

    .input{
      width:100%;
      padding: 13px 13px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-weight: 800;
      outline:none;
      font-size: 14px;
      margin-top: 10px;
    }
    .miniBtn{
      width:100%;
      margin-top:10px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(30,247,217,.25);
      background: rgba(30,247,217,.12);
      color: #dffef8;
      font-weight: 900;
      cursor:pointer;
    }
    .result{
      margin-top:10px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.90);
      font-weight: 800;
      font-size: 14px;
      line-height: 1.35;
      min-height: 58px;
      overflow-wrap:anywhere;
    }

    .links{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .link{
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: #fff;
      text-decoration:none;
      font-weight: 800;
      opacity:.95;
    }

    footer{
      opacity:.55;
      font-size: 12px;
      padding: 18px 10px 26px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <!-- If this image filename is wrong, the page still works -->
      <img class="logo" src="IMG_6472.jpeg" alt="WALRUS" onerror="this.style.display='none';" />
      <h1>$WALRUS</h1>
      <div class="sub">Presale â€¢ Built on Solana</div>
    </div>

    <div class="card">
      <div id="stageTitle" class="stageTitle">Stage 1 Presale</div>

      <div class="row">
        <div class="pill"><b>Stage Price:</b> <span id="stagePrice">$0.0000001</span></div>
        <div class="pill"><b>Raised:</b> <span id="raisedSol">0.00 SOL</span></div>
      </div>

      <div class="next" id="nextStage">Next Stage at: 1500 SOL</div>

      <a id="buyBtn" class="btn" href="#">BUY WITH SOL</a>
      <div class="smallMuted">Opens Phantom / Solflare</div>

      <div class="sectionTitle">Presale Wallet</div>
      <div class="walletBox" id="walletText"></div>
      <div class="copyBtn" id="copyBtn">ðŸ“‹ Copy Wallet</div>

      <div class="sectionTitle">How to Buy</div>
      <div class="howto">
        <div>1) Tap <b>BUY WITH SOL</b> (opens Phantom/Solflare)</div>
        <div>2) Send SOL to the wallet above</div>
        <div>3) Save your <b>Solscan TX link</b> (proof of payment)</div>
        <div>4) Tokens are distributed after launch (official updates)</div>
        <div class="tip">Tip: Donâ€™t send from an exchange. Send from Phantom/Solflare.</div>
      </div>

      <div class="statusLine" id="statusLine">Loadingâ€¦</div>

      <div class="grid">
        <div class="card" style="margin:0;">
          <div style="text-align:center; font-weight:1000; font-size:18px;">Estimate My Tokens</div>
          <div style="text-align:center; color:var(--muted2); font-weight:700; font-size:13px; margin-top:6px;">
            Enter how much SOL you sent (estimate uses current stage price).
          </div>
          <input id="solInput" class="input" type="number" step="0.0001" placeholder="SOL you sent (example: 1.5)" />
          <button id="calcBtn" class="miniBtn" type="button">Calculate</button>
          <div id="tokenEstimate" class="result">Enter SOL amount to calculateâ€¦</div>
        </div>

        <div class="card" style="margin:0;">
          <div style="text-align:center; font-weight:1000; font-size:18px;">Check My Contribution (Optional)</div>
          <div style="text-align:center; color:var(--muted2); font-weight:700; font-size:13px; margin-top:6px;">
            If this ever causes issues, you can disable it (1 setting in code).
          </div>
          <input id="buyerWalletInput" class="input" placeholder="Your Solana wallet address" />
          <button id="checkBtn" class="miniBtn" type="button">Check</button>
          <div id="checkResult" class="result">Paste wallet â†’ tap Check.</div>
        </div>
      </div>
    </div>

    <div class="links">
      <a class="link" href="https://x.com/walrusmemecoin" target="_blank" rel="noreferrer">Official X: @walrusmemecoin</a>
      <a class="link" id="solscanLink" href="#" target="_blank" rel="noreferrer">View Wallet on Solscan</a>
    </div>

    <footer>
      Stages update automatically based on SOL in the presale wallet.
      Always verify addresses and official links.
    </footer>
  </div>

  <script>
    /***********************
     * SETTINGS
     ***********************/
    const PRESALE_WALLET = "9RHnZobeZBKSLDaTVEiKk5FewZapSTJfyHnR396d7QEi";

    const TOTAL_STAGES = 20;
    const SOL_PER_STAGE = 1500;

    // Price ladder: Stage N = N * 0.0000001 USD
    // Stage 1: 0.0000001
    // Stage 2: 0.0000002
    const PRICE_STEP_USD = 0.0000001;

    // If the contribution scanner causes issues, set this to false:
    const ENABLE_CONTRIBUTION_SCAN = true;

    const RPC_URL = "https://api.mainnet-beta.solana.com";

    /***********************
     * SAFE HELPERS
     ***********************/
    function formatSol(n){
      return (Math.floor(n * 100) / 100).toFixed(2) + " SOL";
    }

    // Always show full zeros, never scientific notation
    function formatUsdStagePrice(n){
      // 0.0000001 -> "0.0000001"
      return "$" + n.toFixed(7);
    }

    function getStageFromRaised(raisedSol){
      const idx = Math.floor(raisedSol / SOL_PER_STAGE) + 1;
      return Math.max(1, Math.min(TOTAL_STAGES, idx));
    }

    function getStagePrice(stage){
      return stage * PRICE_STEP_USD;
    }

    function nextThreshold(stage){
      if(stage >= TOTAL_STAGES) return null;
      return stage * SOL_PER_STAGE;
    }

    async function rpc(method, params){
      const res = await fetch(RPC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ jsonrpc:"2.0", id:1, method, params })
      });
      const data = await res.json();
      if (data && data.error) throw new Error(data.error.message || "RPC error");
      return data ? data.result : null;
    }

    async function fetchWalletBalanceSol(address){
      const result = await rpc("getBalance", [address, { commitment: "confirmed" }]);
      const lamports = result && typeof result.value === "number" ? result.value : 0;
      return lamports / 1_000_000_000;
    }

    // Best-effort scan: never crashes the page
    async function getBuyerSentSOLToPresale(buyerAddress, limit=40){
      try{
        const sigs = await rpc("getSignaturesForAddress", [buyerAddress, { limit }]);
        if (!Array.isArray(sigs)) return 0;

        let total = 0;

        for (const s of sigs){
          const tx = await rpc("getTransaction", [s.signature, { maxSupportedTransactionVersion: 0 }]);
          if (!tx || !tx.transaction || !tx.meta) continue;

          const keys = tx.transaction.message.accountKeys || [];
          const meta = tx.meta;

          const idx = keys.findIndex(k => (typeof k === "string" ? k : k.pubkey) === PRESALE_WALLET);
          if (idx === -1) continue;

          const pre = (meta.preBalances && meta.preBalances[idx]) ? meta.preBalances[idx] : 0;
          const post = (meta.postBalances && meta.postBalances[idx]) ? meta.postBalances[idx] : 0;

          const deltaLamports = post - pre;
          if (deltaLamports > 0) total += deltaLamports / 1e9;
        }
        return total;
      }catch(e){
        return 0;
      }
    }

    function updateUI(raisedSol){
      const stage = getStageFromRaised(raisedSol);
      const price = getStagePrice(stage);
      const next = nextThreshold(stage);

      document.getElementById("stageTitle").textContent = `Stage ${stage} Presale`;
      document.getElementById("stagePrice").textContent = formatUsdStagePrice(price);
      document.getElementById("raisedSol").textContent = formatSol(raisedSol);

      const nextEl = document.getElementById("nextStage");
      nextEl.textContent = (next === null)
        ? `Final Stage Reached (Stage ${TOTAL_STAGES})`
        : `Next Stage at: ${next} SOL`;
    }

    async function refresh(){
      const status = document.getElementById("statusLine");
      try{
        status.textContent = "Updatingâ€¦";
        const sol = await fetchWalletBalanceSol(PRESALE_WALLET);
        updateUI(sol);
        status.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      }catch(e){
        status.textContent = "Could not load raised amount. Refresh and try again.";
      }
    }

    // Buttons
    document.getElementById("copyBtn").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(PRESALE_WALLET);
        document.getElementById("copyBtn").textContent = "âœ… Copied!";
        setTimeout(() => document.getElementById("copyBtn").textContent = "ðŸ“‹ Copy Wallet", 1200);
      }catch(e){
        window.prompt("Copy this wallet:", PRESALE_WALLET);
      }
    });

    document.getElementById("calcBtn").addEventListener("click", async () => {
      const solSent = parseFloat(document.getElementById("solInput").value || "0");
      const out = document.getElementById("tokenEstimate");

      if (!solSent || solSent <= 0){
        out.textContent = "Enter a valid SOL amount.";
        return;
      }

      // Estimate uses CURRENT stage
      let raisedSol = 0;
      try { raisedSol = await fetchWalletBalanceSol(PRESALE_WALLET); } catch(e) {}
      const stage = getStageFromRaised(raisedSol);
      const price = getStagePrice(stage);

      const estTokens = (price > 0) ? (solSent / price) : 0;
      out.textContent = `Stage ${stage} price ${formatUsdStagePrice(price)} â†’ ${solSent.toFixed(4)} SOL â‰ˆ ${Math.floor(estTokens).toLocaleString()} WALRUS (estimate)`;
    });

    document.getElementById("checkBtn").addEventListener("click", async () => {
      const buyer = document.getElementById("buyerWalletInput").value.trim();
      const out = document.getElementById("checkResult");

      if (!ENABLE_CONTRIBUTION_SCAN){
        out.textContent = "Contribution check is disabled.";
        return;
      }

      if (!buyer || buyer.length < 32){
        out.textContent = "Paste a valid Solana wallet address.";
        return;
      }

      out.textContent = "Checkingâ€¦ (can take 10â€“30s)";
      const sent = await getBuyerSentSOLToPresale(buyer, 40);

      let raisedSol = 0;
      try { raisedSol = await fetchWalletBalanceSol(PRESALE_WALLET); } catch(e) {}
      const stage = getStageFromRaised(raisedSol);
      const price = getStagePrice(stage);
      const estTokens = (price > 0) ? (sent / price) : 0;

      out.innerHTML =
        `<div><b>SOL sent (recent scan):</b> ${sent.toFixed(4)} SOL</div>` +
        `<div style="margin-top:6px; opacity:.85;"><b>Estimated tokens</b> (Stage ${stage}): ${Math.floor(estTokens).toLocaleString()} WALRUS</div>` +
        `<div style="margin-top:8px; font-size:12px; opacity:.75;">Estimate only. Final allocation depends on your distribution rules.</div>`;
    });

    // Init (never blank)
    (function init(){
      document.getElementById("walletText").textContent = PRESALE_WALLET;
      document.getElementById("buyBtn").setAttribute("href", `solana:${PRESALE_WALLET}`);
      document.getElementById("solscanLink").setAttribute("href", `https://solscan.io/account/${PRESALE_WALLET}`);

      // Set a safe default UI immediately
      updateUI(0);
      document.getElementById("statusLine").textContent = "Loading on-chain dataâ€¦";

      // Refresh on-chain
      refresh();
      setInterval(refresh, 20000);
    })();
  </script>
</body>
</html>
